# Sherpath API (統合版)

omukoro_devdack_clone と sherpath_backend の機能を統合したバックエンドAPIです。

## アプリ名称
**Sherpath**
> 意味：Sherpathは「Sherpa」と「Path」の合成語で、「Sherpa」は登山ガイドを意味し、「Path」は道筋や経路を意味する。このアプリは、利用対象者である事業部門のメンバーが、どんな論点を、どこに相談すべきかの道筋を案内し、適切な相談先に繋げることを目的としており、商品のリリースという高い山を登頂まで伴奏する心強い相棒となることを想定して、Sherpathという名称を採用した。

## 背景・現状の課題
- 酒類の製造販売という規制産業ゆえに、多種多様な法令・ルールへ適合する必要がある。
- 新たな施策を行うにあたって、企画段階から法令やルールへの適合性やリスク検討を行う必要がある。
- リスク検討あたっては、関係する部署との連携が必須となる。
- 関係する部署との連携は行えているが、コミュニケーションコストが高くなっている。

## 提供価値
- 事業部門のメンバーが、検討している施策やサービスの中に、どんな論点があり、その論点を誰に相談すべきかの整理を行い、アプリからTeamsに連携する仕組みで、論点整理から実際の相談までをワンストップでできる体験を提供する。

## メインターゲット
- 業務歴1〜3年目の商品企画担当者（新商品プロジェクトの中心推進者）
- 特徴：商品構想〜社内連携〜発売実現までのプロジェクトリーダー。営業・中身開発・製造・品質保証・法務・購買など関係者を巻き込んで進行。初期段階の「どんな商品をつくるか」「どんな売り方が可能か」において、法令や業界ルールの壁が大きく、社内調整が多い。
- 課題：何を調べればよいか分からず、相談の仕方も不明。関係者が多く、対応が重複する。
- ニーズ：この相談は、どこに・誰に相談すべきなのかを整理して、担当者につないで欲しい。社内で過去に似た事例があるかどうかも知りたい（「過去どうしたか」への依存度が高い

## アプリのコンセプト
**「答えるAI」から「導くAI」へ**

## アプリの機能概要
- 自分の相談内容をダッシュボードで管理・閲覧できる
- 施策内容を入力して論点等を整理する機能、企画書や計画書など資料をアップロードして論点等を整理する機能の2機能がある
    - 論点等の整理は、生成AI（RAG）を用いて適切な論点整理と相談先の提案を行う
- ログイン機能を用いて、セキュアなアプリ利用を実現する
- 自分の論点整理内容がデータベース（MySQLおよびベクトルデータベース）に蓄積されていく
- 他の人の論点整理を検索して確認できる
- 様々な人の論点整理内容がデータベースに蓄積されることで、AIによる回答精度が向上する

## 技術スタック
### バックエンド
- Python
- FastAPI
- Langchain
- Langgraph

### データベース
- MySQL
- MongoDB

### 生成AI
- OpenAI

## アプリの機能詳細
- **ログイン機能**
> 実装済みのため作成不要
    - アプリを開いた最初のページに表示される
    - ログインはメールアドレスとパスワード（8文字以上）で行う
    - 認証処理をJWT（JSON Web Token）を用いて行う
    - ログイン後は、メニュー画面に遷移する
    - ログインしていない場合は、ログイン画面に遷移する
    - パスワードはハッシュ化して保存する（bcryptを用いる）
    - 操作ログが操作ログデータベースに蓄積される
    - ユーザーマスタにはid、email、password_hash、role、is_active、created_at	DATETIME、updated_atが保存される

- **相談したい施策内容の入力機能**
    - ログイン後に、相談したい施策内容の入力画面が表示される。
    - 入力欄に相談したい施策内容を入力する。
    - 入力の他、アップロードした企画書・計画書などの資料をもとに、論点・質問事項の整理と相談先の分析を行う。
        - 対象ファイル形式：Word（.docx）、Excel（.xlsx）のみ（それ以外は対象外）
        - 取得方式：Word/Excelはテキスト抽出を行い、リアルタイム分析に合算して利用する（OCRは使用しない）

    - **リアルタイム入力分析機能**
        - 入力内容に対して、論点や質問事項を整理するために情報が不足しているのか、具体的になっているのかをリアルタイムで判定し、不足している情報を追加で入力するように促す。
        - **判定方式：ハイブリッド分析**
            - **ルールベース判定**：キーワードの有無と文章構造を即座に分析（レスポンス時間：即時）
                - 商品・サービス内容の記載有無
                - ターゲット顧客の明確性
                - スケジュール・時期の記載  
                - 目的・目標の明確性
            - **AI判定**：OpenAI APIを活用した詳細分析（レスポンス時間：800ms後、デバウンス処理）
                - 文章の論理構造分析
                - 情報の具体性評価
                - 不足情報の特定と提案生成
        - **5段階進行バー表示（RealtimeProgressBar）**
            - **1〜2段階（不足・グレー）**：基本的な情報が大幅に不足している状態
            - **3段階（中程度・イエロー）**：ある程度の情報はあるが、詳細化が必要な状態
            - **4段階（高程度・オレンジ）**：相談可能レベルに近いが、若干の追記が望ましい状態
            - **5段階（充足・グリーン）**：論点整理に十分な情報が揃っている状態
        - **リアルタイム提案機能**
            - 具体的な追加推奨項目を動的に提示
            - 例：「ターゲット層の詳細」「予算規模」「実施時期」等
        - **パフォーマンス最適化**
            - デバウンス処理（800ms）でAPI呼び出し頻度を制御
            - キャッシュ機能により同一入力の高速レスポンス
            - 段階的判定：即座のルールベース → 詳細なAI分析の順で実行
        - **APIエンドポイント**
            - /api/analyze
            - POSTメソッド
            - リクエストボディ：{ "text": "相談内容" }
            - レスポンスボディ：{ "completeness": 0.8, "suggestions": ["論点1", "論点2"], "confidence": 0.9 }
    - 入力完了したら、「相談する」ボタンをクリックすることで、バックエンドで連携する生成AI・RAGによって、論点・質問事項の整理と相談先の分析を行う。

- **論点・質問事項と相談先の表示**
    - 入力されたテキスト情報又は/及びアップロードされた企画書・計画書などの資料をもとに、生成AIによって論点・質問事項の整理と相談先の分析を行う。
    - 分析には、RAGを用いて、法令や過去の相談事例を参照して、論点・質問事項の整理と相談先の分析を行う。
    - 分析結果のレスポンスは、*相談者が入力した相談内容*, *整理した論点や相談先に聞く質問内容*, *相談先の担当者*の3つの項目に分けて表示する。
    - 分析結果は、データベースに蓄積される。
    - データベースには、相談者が入力した相談内容、整理した論点や相談先に聞く質問内容、相談先の担当者の情報が保存される。
    - **APIエンドポイント**
        - /api/analytics
        - POSTメソッド
        - リクエストボディ：{ "text": "相談内容" }
        - レスポンスボディ：   {"summary": "相談内容の要約", "questions": ["質問事項1","質問事項2", "質問事項3"],"consultants": [ { "name": "相談先1","department": "部署名","expertise": "専門分野"},{"name": "相談先2","department": "部署名", "expertise": "専門分野"}],"analysis_metadata": {"confidence": 0.85,"generated_at": "2024-01-01T12:00:00Z"}}

- **Teamsとの連携による相談先への相談**
    - 論点・質問事項と相談先が表示された後、「相談先に送信」ボタンをクリックすることで、Teamsとの連携による相談先への相談を行う。
    - ボタンクリック後にTeamsが立ち上がり、相談相手にメンション付きで相談内容、整理した論点や質問内容が指定したチャネルに投稿される。
    - 相談先へのメッセージ送信は、TeamsのAPIを用いて行う。
    - **APIエンドポイント**
        - /api/send_message
        - POSTメソッド
        - リクエストボディ：{ "text": "相談内容", "questions": ["質問事項1","質問事項2", "質問事項3"],"consultants": [ { "name": "相談先1","department": "部署名","expertise": "専門分野"},{"name": "相談先2","department": "部署名", "expertise": "専門分野"}]}
        - レスポンスボディ：{ "status": "success" }

- **自分が実施した論点整理内容の履歴確認**
    - 自分が実施した論点整理の履歴を確認できる。
    - 履歴は検索もでき、検索は、相談先の名前や部署名、専門分野などで行う。
    - 検索結果は、相談先の名前、部署名、論点整理内容を表示する。

- **他の人の論点整理内容の検索**
    - 他の人の論点整理内容を検索できる。
    - 検索は、相談先の名前や部署名、専門分野などで行う。
    - 検索結果は、相談先の名前、部署名、論点整理内容を表示する。

## ディレクトリ構成
### バックエンド

#### 概要
- 技術: FastAPI（Python）、OpenAI API、（任意）Redisキャッシュ
- 方針: ルールベース分析 + AI分析のハイブリッド構成。フロントのデバウンス（800ms）を前提に、毎リクエストで統一インターフェースを提供。

#### エンドポイント
- POST `/api/extract_text`
  - 受領: `multipart/form-data`（フィールド名`files[]`、拡張子`.docx`/`.xlsx`のみ）
  - 返却: `{ extractedText: string, files: [{ name: string, bytes: number }] }`
  - 役割: Word/Excelからテキスト抽出。OCRは不使用。
  - 制約: 拡張子バリデーション、サイズ上限、同時アップロード数（詳細は下記「制限」）。

- POST `/api/analyze`
  - 受領: `{ text: string, docText?: string }`
  - 返却: `{ completeness: 1|2|3|4|5, suggestions: string[], confidence?: number }`
  - 役割: ルールベース即時判定 + OpenAIによる詳細提案の統合応答。
  - キャッシュ: 正規化した`text + docText`をキーにキャッシュ（下記参照）。

（参考）他機能で利用: `/api/analytics`（論点/相談先分析）、`/api/send_message`（Teams連携）

#### 分析フロー（/api/analyze）
1) 入力統合・前処理
   - `normalizedText = trim(text + "\n\n" + (docText || ""))`
   - 長文対策: 先頭N文字（例: 4000–6000文字）へクリップ、正規化（全角/半角/改行整形）

2) ルールベース判定（即時）
   - チェック項目（6分類）
     - 商品・サービス内容 / 対象顧客・ターゲット / スケジュール・時期 / 目的・目標 / 市場・競合分析（任意）
   - 各分類のキーワード/構文（例: 金額/日時/対象語/目的語）を抽出し、充足数`covered`を算定
   - 基礎提案: 欠落分類に対する不足提案を生成

3) AI判定（デバウンス後にフロントから呼出）
   - OpenAIへ`normalizedText`とルールベース結果をプロンプト化し、
     - 具体化提案の充実 / 論理構造の確認 / 重複削減 / 表現の明確化 を生成
   - `suggestions`を統合（重複排除・優先度付け）

4) スコアリング → 5段階化
   - 完成度スコア`s`（0.0–1.0）を内部計算（例: `s = (covered / 5) * α + aiConfidence * (1-α)`、`α`は0.6目安）
   - 段階マッピング（前提: フロント表示は5段階）
     - 0.00–0.19 → 1（不足）
     - 0.20–0.39 → 2（不足）
     - 0.40–0.59 → 3（中程度）
     - 0.60–0.79 → 4（高程度）
     - 0.80–1.00 → 5（充足）
   - `confidence`はAI応答の自己評価やプロンプト制約違反の有無を考慮して算出（0–1）

#### キャッシュ方針
- キー: `sha256(normalizedText)`
- 値: `AnalyzeResponse`（`completeness`/`suggestions`/`confidence`）
- TTL: 1時間（要件に応じて可変）。ヒット時は即応答し、サーバ負荷とコストを削減。

#### エラー/制限/保護
- 制限
  - `/api/extract_text`: 1ファイル最大10MB、同時最大3ファイル、拡張子は`.docx/.xlsx`のみ
  - `/api/analyze`: `text+docText`合計最大64KB（超過時はクリップ）
- 応答コード
  - 400: バリデーション不備（拡張子/必須項目）
  - 413: ペイロード過大
  - 429: レートリミット超過（IP/ユーザー単位）
  - 500: 予期せぬエラー
- 保護
  - 認証: JWT検証（ログイン済みのみ許可）
  - ログ: 監査用にリクエスト/応答メタデータを記録（本文はPII対策でマスキング/要約）

#### 型（Pydantic想定）
```json
// AnalyzeRequest
{ "text": "string", "docText": "string?" }

// AnalyzeResponse
{ "completeness": 1, "suggestions": ["string"], "confidence": 0.85 }

// ExtractTextResponse
{ "extractedText": "string", "files": [{ "name": "string", "bytes": 12345 }] }
```

#### 実装構成（例）
- ルーター: `api/analyze.py`, `api/extract_text.py`, `api/health.py`
- サービス: `services/analysis_service.py`（ルール+AI統合）, `services/cache_service.py`
- ユーティリティ: `utils/rule_analyzer.py`（正規表現/キーワード辞書）, `utils/text_normalizer.py`
- モデル: `models/schemas.py`（Pydanticモデル）


## 更新履歴
- 2025/08/01 初版作成
- 2025/08/02 文言を一部修正
- 2025/08/09 ディレクトリ構成を更新

## 機能

- **企画案分析**: テキストの充実度を分析
- **法令検索**: Cosmos DBを使用したベクトル検索
- **相談提案生成**: OpenAI APIを使用した相談内容分析
- **ヘルスチェック**: 各サービスの状態確認

## 技術スタック

- **FastAPI**: 0.104.1
- **Python**: 3.8+
- **データベース**: Cosmos DB (MongoDB API)
- **キャッシュ**: Redis
- **AI**: OpenAI API

## セットアップ

### 1. 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 2. 環境変数の設定

`env.example` を `.env` にコピーして、必要な値を設定してください：

```bash
cp env.example .env
```

必要な環境変数：
- `OPENAI_API_KEY`: OpenAI APIキー
- `MONGODB_CONNECTION_STRING`: Cosmos DB接続文字列
- `REDIS_URL`: Redis接続URL

### 3. アプリケーションの起動

```bash
python main.py
```

または

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

## API エンドポイント

### 分析関連
- `POST /api/analyze`: テキストの充実度分析
- `GET /api/analyze/test`: 分析機能のテスト

### 相談関連
- `POST /api/consultations/generate-suggestions`: 相談提案生成
- `GET /api/consultations/{consultation_id}`: 相談詳細取得
- `GET /api/consultations/{consultation_id}/regulations`: 関連法令取得

### システム
- `GET /api/health`: ヘルスチェック
- `GET /`: ルート情報
- `GET /info`: アプリケーション情報

## プロジェクト構造

```
omukoro_devdack_test/
├── app/
│   ├── api/           # APIルーター
│   ├── models/        # Pydanticモデル
│   ├── services/      # ビジネスロジック
│   └── utils/         # ユーティリティ
├── main.py            # メインアプリケーション
├── requirements.txt   # 依存関係
└── README.md         # このファイル
```

## 注意事項

- Cosmos DBへの接続が必要です
- OpenAI APIキーの設定が必要です
- Redisはオプションですが、キャッシュ機能を使用する場合は必要です
